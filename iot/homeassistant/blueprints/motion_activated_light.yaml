blueprint:
  name: Motion-activated Light/Switch
  source_url: https://github.com/swibrow/home-ops/blob/main/iot/homeassistant/blueprints/motion_activated_light.yaml
  description: |
    Run custom actions when motion is detected.
    Supports multiple motion sensors and any action for both motion detected
    and motion cleared events.

    Actions are triggered when any sensor detects motion and again after a
    configurable delay once all sensors are clear.
  domain: automation
  author: Home Assistant
  input:
    motion_entities:
      name: Motion Sensors
      description: One or more motion or occupancy sensors to monitor
      selector:
        entity:
          multiple: true
          filter:
            - device_class: occupancy
              domain: binary_sensor
            - device_class: motion
              domain: binary_sensor
    motion_detected_action:
      name: Motion Detected Action
      description: Action to run when motion is detected (e.g., turn on light, run scene)
      default: []
      selector:
        action: {}
    motion_cleared_action:
      name: Motion Cleared Action
      description: Action to run after all motion stops and wait time elapses (e.g., turn off light)
      default: []
      selector:
        action: {}
    no_motion_wait:
      name: Wait time
      description: Time to wait after last motion before running motion cleared action
      default: 120
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds

mode: restart
max_exceeded: silent

triggers:
  - trigger: state
    entity_id: !input motion_entities
    from: "off"
    to: "on"

variables:
  motion_sensors: !input motion_entities

actions:
  - alias: "Run motion detected action"
    choose:
      - conditions: "{{ true }}"
        sequence: !input motion_detected_action
  - alias: "Wait until all motion sensors are clear"
    wait_template: "{{ expand(motion_sensors) | selectattr('state', 'eq', 'on') | list | count == 0 }}"
  - alias: "Wait the number of seconds that has been set"
    delay: !input no_motion_wait
  - alias: "Run motion cleared action"
    choose:
      - conditions: "{{ true }}"
        sequence: !input motion_cleared_action
